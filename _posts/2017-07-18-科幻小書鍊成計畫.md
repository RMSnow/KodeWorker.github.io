---
layout: single
title: 科幻小說鍊成計畫(構建中)
date: 2017-07-18 15:56:51
excerpt: 紀錄我用程式自動生成科幻小說的學習歷程。
categories:
- 計畫
tags:
- procedural generation
- NaNoWriMo
- NaNoGenMo
- web scraping
- LSTM
- GAN
---

{% include toc title = "目錄" %}

## 前言

十一月越來越逼進了，那是一年一度的[國家小說寫作月](http://nanowrimo.org/)(National Novel Writing Month)了，身為文藝愛好者的我，怎麼可能錯過這場盛事呢？
雖然還有好一段時間，但是現在不好好開始規劃，慢慢利用零碎的時間持之以恆的學習，應該很難產生出有趣的成果。
在年初時候，我對遊戲相關的演算法非常感興趣，當時實作了尋找路徑的A*演算法、以及取得視野的ray-casting，接著慢慢地把興趣轉向了程序化生成(procedural generation)。
在網路上找到了一篇滿有趣的[文章](https://mewo2.com/notes/naming-language/)，作者是由奇幻小說的地名為發想，想要創造一組虛構的語言來對小說中的世界進行命名，文章中一步步從語言學的角度，由音節、字符逐步構建簡單的語言。
仔細看了一下文章開頭，天那竟然是為了[NaNoGenMo](https://nanogenmo.github.io/)，國家小說產生月！
在寒冬時節，想像屋外冰天雪地，愜意地坐在火爐邊寫小說、讀小說，外加一杯香濃的熱可可，真是人生一大享受。但是這時一群腦洞大開程式員，不畏寒冬守在螢幕前敲著鍵盤，打算用程式碼來拯救全世界。

>「你用筆來寫小說？」
>
>「太遜了，我們都用程式來生成小說」

引起我極大興趣的另一個原因是，去年年底在reddit上讀到了關於Machine Learning conference的報導，其中Generative Adversarial Networks(GAN)受到高度的評價，被譽為是近十年來最棒的演算法。
最近台大[李宏毅教授](http://speech.ee.ntu.edu.tw/~tlkagk/index.html)也來到中心演講也是在介紹GAN，其中就有唐詩鍊成的範例，雖然語句不太有意義，但我認為是一個很好的參考指標。
接著是清大[張俊盛教授](http://www.nlplab.cc/)來中心介紹自然語言處理，這個課程講得概念很粗略，反而是老師為自然語言、機器翻譯畫了一個美好大餅，希望吸引博士生加入一起努力(讀博士？算了吧！)。
不過重點有提到，目前主流使用的Neural Machine Translation，由於忽略的語句的文法構成，仍有許多值得改進的地方。
聽完這一系列的演講，內心的熱血已在蠢蠢欲動，所以想利用NaNoGenMo這個性質比較輕鬆的活動，慢慢從頭規劃程式並產生至少能讀的科幻小說。

## 程式規劃
在施放鍊金術前，總是要有基本素材才能進行鍊成，直接無中生有已經不是鍊金術了，那已經是另一個次元位面的事情了。
大致上先將目前計畫規劃為下列三大部分，再逐一慢慢完成每個區塊。

1. 網路爬蟲：收集已在公共領域、不會侵權的小說文章。
2. 構建文句產生器：參考[這篇文章](http://machinelearningmastery.com/text-generation-lstm-recurrent-neural-networks-python-keras/)，利用LSTM自動產生文句。
3. 利用GAN鍊出最佳文章

先建立一個[Github Project](https://github.com/KodeWorker/NovelAlchemist)來存放我的工作進度。

### 網路爬蟲
#### 網站資源
為了要生成科幻小說，想當然耳要先去找尋相關類型的文章，有礙於著作權法，所以只能找尋已經開放於公共領域(public domain)的小說。
在網路上搜索相關資訊的過程中，發現了一篇介紹[25個存放公共領域書籍的免費網站](https://ebookfriendly.com/free-public-domain-books-sources/)，裡面有很完整的介紹。
其中最大的網站，[Project Gutenberg](http://www.gutenberg.org/)，是我心目中收集鍊金素材的最佳網站，但是很不幸它的使用條款其中一條寫道：

> **The Project Gutenberg website is for human users only.** Any real or perceived use of automated tools to access our site will result in a block of your IP address. This site utilizes cookies, captchas and related technologies to help assure the site is maximally available for human users only.

雖然之前看的[書本](https://automatetheboringstuff.com/chapter11/)裡，介紹到Web Scraping也是從Project Gutenberg下載羅密歐與茱麗葉，但是身為腦包研究者一定先把25個網站一個個看過，再決定我們的行動方針。
在排名第6的[Feedbooks](http://www.feedbooks.com/publicdomain)也是有非常多的公共領域書籍，其中科幻類的就有1176本！但是看到使用條例，心也涼了一半，不過條款的力道似乎沒有像Project Gutenberg那麼嚴厲。

> **6.15** use any robot, spider, scraper, or other automated means to access the FeedBooks Website bypass any measures FeedBooks may use to prevent or restrict access to the FeedBooks Website

小王子曾說過：『沙漠之所以這麼美，是因為在某個角落裡，藏著一口井。星星好美，是因為一朵我們看不見的花。』
現在終於讓我找到了，那個藏在沙漠角落的那一口井了，那就是[Manybooks](http://manybooks.net/)，這個網站雖然也收集了Project Gutenberg及其他網路資源，但是使用條款中完全沒有限制網路爬蟲，簡直是佛心公司。

#### 程式撰寫
整體的主程式架構如下
{% highlight python %}
    if __name__ == '__main__':
        url = 'manybooks.net'
        # select=54 : Science Fiction
        genre_link = sel_genre(url, select=54)
        # select=10 : English
        lang = sel_language(genre_link, select=10)
        # first page of the selected genre
        page = genre_link + '/' + lang

        while True:
            print('access...%s' %page)
            res = requests.get(page)
            res.raise_for_status()
            soup = bs4.BeautifulSoup(res.text)
            try:
                # get "next page" button
                button_elems = soup.select('a[title="next"]')[0]        
                page = 'http://%s%s' %(url, button_elems.get('href'))

                # find books and download .txt files
                download_books_in_page(page)

                # employ random delay
                time.sleep(5+random.randint(2,10))
            except:
                # no "next page" button
                print('end of pages')
                break
{% endhighlight %}

首先我們要先取得所有小說的類型，如此一來方便我們未來的使用，未來可以挑選其他非科幻題材來鍊成文章。
{% highlight python %}
    def sel_genre(url='manybooks.net', select=None):
        """ Select Genre
        This function allows user to select a particular genre from "manybooks.net"
        and it returns the link to the first page of selected genre.

        Parameters
        ----------
        url: string, default='manybooks.net'
            The URL of "Manybooks".
        select: int, default=None
            The number of selection. If the value is None, the console will display
            all the genres and requires an user input.

        Return
        ------
        link: string
            The URL of the first page of the selected genre.
        """
        genre_url = 'http://%s/%s' %(url, 'categories')
        genre_dict = {}
        genre_list = []

        res = requests.get(genre_url)
        res.raise_for_status()
        soup = bs4.BeautifulSoup(res.text)
        elems = soup.select('a[class="larger"]')

        for elem in elems:
            genre_name = elem.getText()
            genre_link = 'http://%s%s' %(url, elem.get('href'))        
            genre_dict[genre_name] = genre_link
            genre_list.append(genre_name)

        # Display Genre Selection
        if select == None:
            for i in range(len(genre_list)):
                print('[%d] : %s' %(i+1, genre_list[i]))
            select = input('Select the Genre (no.) >> ')

            if not (int(select) > 0 and int(select) < len(genre_list)+1):
                raise ValueError('Wrong selection number!')

        print('genre: %s' %genre_list[int(select)-1])

        link = genre_dict[genre_list[int(select)-1]]
        return link
{% endhighlight %}

接著要選取對應的語言。
{% highlight python %}
    def sel_language(url, select=None):
        """ Select Language
        This function allows user to select a particular language in the pages of
        each genre and it returns the link to the page of books with selected
        language.

        Parameters
        ----------
        url: string
            The URL of the first selected genre page.
        select: int, default=None
            The number of selection. If the value is None, the console will display
            all the language and requires an user input.

        Return
        ------
        link: string
            The URL of the first page of the selected genre and selected language.
        """
        lang_dict = {}
        lang_list = []

        res = requests.get(url)
        res.raise_for_status()
        soup = bs4.BeautifulSoup(res.text)
        elems = soup.select('option')

        for elem in elems:
            lang_name = elem.getText()
            lang_value = elem.get('value')
            lang_dict[lang_name] = lang_value
            lang_list.append(lang_name)

        # Display language Selection
        if select == None:
            for i in range(len(lang_list)):
                print('[%d] : %s' %(i+1, lang_list[i]))
            select = input('Select the Genre (no.) >> ')

            if not (int(select) > 0 and int(select) < len(lang_list)+1):
                raise ValueError('Wrong selection number!')

        print('language: %s' %lang_list[int(select)-1])
        return lang_dict[lang_list[int(select)- 1]]
{% endhighlight %}

最後就是最重要，下載頁面的部份。
-------
以下待續
